<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disclaimer Checker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .upload-container {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }
        input[type="file"] {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            margin: 20px 0;
            color: #666;
        }
        .error {
            color: red;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile && selectedFile.type === 'application/pdf') {
                    setFile(selectedFile);
                    setError(null);
                } else {
                    setError('Please select a PDF file');
                    setFile(null);
                }
            };

            const handleUpload = async () => {
                if (!file) {
                    setError('Please select a PDF file first');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('http://localhost:8000/api/analyze/', {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Upload failed');
                    }

                    const data = await response.json();
                    
                    // Store filename for use in results
                    const filename = file.name;
                    
                    // Helper function to escape HTML
                    function escapeHtml(text) {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }
                    
                    const resultsWindow = window.open('', '_blank');
                    const comments = data.comments || [];
                    
                    resultsWindow.document.write(`
                        <html>
                            <head>
                                <title>Analysis Results</title>
                                <style>
                                    * { margin: 0; padding: 0; box-sizing: border-box; }
                                    body {
                                        font-family: Arial, sans-serif;
                                        height: 100vh;
                                        display: flex;
                                        flex-direction: column;
                                        overflow: hidden;
                                    }
                                    .status-box {
                                        padding: 10px 20px;
                                        background: ${data.result.is_approved ? '#d4edda' : '#f8d7da'};
                                        border-bottom: 2px solid ${data.result.is_approved ? '#28a745' : '#dc3545'};
                                        display: flex;
                                        gap: 20px;
                                        align-items: center;
                                        flex-shrink: 0;
                                    }
                                    .status-text {
                                        font-weight: bold;
                                        color: ${data.result.is_approved ? '#155724' : '#721c24'};
                                    }
                                    .risk-text {
                                        color: ${data.result.risk_level === 'LOW' ? '#28a745' : data.result.risk_level === 'MEDIUM' ? '#ffc107' : '#dc3545'};
                                        font-weight: 500;
                                    }
                                    .main-container {
                                        display: flex;
                                        flex: 1;
                                        overflow: hidden;
                                    }
                                    .pdf-container {
                                        flex: 1;
                                        display: flex;
                                        flex-direction: column;
                                        overflow: hidden;
                                    }
                                    iframe {
                                        flex: 1;
                                        border: none;
                                        width: 100%;
                                    }
                                    .comments-panel {
                                        width: 350px;
                                        background: #f8f9fa;
                                        border-left: 1px solid #ddd;
                                        display: flex;
                                        flex-direction: column;
                                        overflow: hidden;
                                    }
                                    .comments-header {
                                        padding: 15px;
                                        background: #fff;
                                        border-bottom: 1px solid #ddd;
                                        font-weight: bold;
                                        font-size: 14px;
                                    }
                                    .comments-list {
                                        flex: 1;
                                        overflow-y: auto;
                                        padding: 10px;
                                    }
                                    .comment-item {
                                        background: #fff;
                                        border-left: 4px solid #ccc;
                                        padding: 12px;
                                        margin-bottom: 10px;
                                        border-radius: 4px;
                                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                                        cursor: pointer;
                                        transition: background-color 0.2s;
                                        user-select: none;
                                    }
                                    .comment-item:hover {
                                        background: #e9ecef;
                                        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
                                    }
                                    .comment-item:active {
                                        background: #dee2e6;
                                    }
                                    .comment-header {
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        margin-bottom: 8px;
                                        font-size: 12px;
                                        color: #666;
                                    }
                                    .comment-color-dot {
                                        width: 12px;
                                        height: 12px;
                                        border-radius: 50%;
                                        flex-shrink: 0;
                                    }
                                    .comment-type {
                                        font-weight: 600;
                                        color: #333;
                                    }
                                    .comment-text {
                                        color: #333;
                                        line-height: 1.5;
                                        margin-bottom: 8px;
                                    }
                                    .comment-highlight {
                                        background: #f0f0f0;
                                        padding: 8px;
                                        border-radius: 3px;
                                        font-size: 11px;
                                        color: #666;
                                        font-style: italic;
                                        margin-top: 8px;
                                    }
                                    .comment-jurisdiction {
                                        font-size: 11px;
                                        color: #999;
                                        margin-top: 4px;
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="status-box">
                                    <span class="status-text">${data.result.is_approved ? '✓ APPROVED' : '✗ NOT APPROVED'}</span>
                                    <span class="risk-text">Risk: ${data.result.risk_level}</span>
                                </div>
                                <div class="main-container">
                                    <div class="pdf-container">
                                        ${data.annotated_pdf_base64 ? `
                                            <iframe src="data:application/pdf;base64,${data.annotated_pdf_base64}"></iframe>
                                        ` : `
                                            <div style="padding: 50px; text-align: center;">
                                                <p>No annotated PDF available.</p>
                                            </div>
                                        `}
                                    </div>
                                    <div class="comments-panel">
                                        <div class="summary-blurb" style="padding: 12px 15px; background: #fff; border-bottom: 1px solid #eee; font-size: 13px; line-height: 1.5; color: #333;">
                                            ${escapeHtml(data.result.summary_blurb || (data.result.is_approved ? 'This document meets the checklist requirements.' : 'This document was not approved. See comments for details.'))}
                                        </div>
                                        <div class="comments-header">COMMENTS (${comments.length})</div>
                                        <div class="comments-list">
                                            ${comments.length > 0 ? comments.map((comment, idx) => {
                                                const searchText = escapeHtml(comment.search_text || comment.highlighted_text || '').replace(/'/g, "\\'");
                                                return `
                                                <div class="comment-item" 
                                                     style="border-left-color: ${comment.color}"
                                                     onclick="navigateToHighlight(${comment.page}, '${searchText}')"
                                                     data-page="${comment.page}">
                                                    <div class="comment-header">
                                                        <div class="comment-color-dot" style="background-color: ${comment.color}"></div>
                                                        <span class="comment-type">${comment.type}</span>
                                                        <span style="margin-left: auto;">Page ${comment.page}</span>
                                                    </div>
                                                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                                                    ${comment.highlighted_text ? `
                                                        <div class="comment-highlight">"${escapeHtml(comment.highlighted_text)}"</div>
                                                    ` : ''}
                                                    ${comment.jurisdiction ? `
                                                        <div class="comment-jurisdiction">${comment.jurisdiction}</div>
                                                    ` : ''}
                                                </div>
                                            `;
                                            }).join('') : '<div style="padding: 20px; text-align: center; color: #999;">No comments</div>'}
                                        </div>
                                    </div>
                                </div>
                            </body>
                        </html>
                    `);
                    
                    // Add navigation function after document is written
                    resultsWindow.navigateToHighlight = function(pageNum, searchText) {
                        const iframe = resultsWindow.document.querySelector('iframe');
                        if (!iframe || !iframe.contentWindow) return;
                        try {
                            const pdfViewer = iframe.contentWindow.PDFViewerApplication;
                            if (pdfViewer) {
                                pdfViewer.page = pageNum - 1;
                                if (searchText && searchText.length > 10) {
                                    setTimeout(function() {
                                        const findController = pdfViewer.findController;
                                        if (findController) {
                                            findController.executeCommand('find', {
                                                query: searchText.substring(0, 50),
                                                highlightAll: true,
                                                caseSensitive: false
                                            });
                                        }
                                    }, 500);
                                }
                            } else {
                                iframe.contentWindow.scrollTo(0, 0);
                                const src = iframe.src.split('#')[0];
                                iframe.src = src + '#page=' + pageNum;
                            }
                        } catch (e) {
                            console.error('Navigation error:', e);
                            const src = iframe.src.split('#')[0];
                            iframe.src = src + '#page=' + pageNum;
                        }
                    };
                    
                    resultsWindow.document.close();

                } catch (err) {
                    setError(err.message || 'Failed to upload and analyze PDF');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h1>Marketing Disclaimer Checker</h1>
                    <div className="upload-container">
                        <h2>Upload PDF for Analysis</h2>
                        <input
                            type="file"
                            accept=".pdf"
                            onChange={handleFileChange}
                            disabled={loading}
                        />
                        <br />
                        {file && <p>Selected: {file.name}</p>}
                        <button 
                            onClick={handleUpload} 
                            disabled={!file || loading}
                        >
                            {loading ? 'Analyzing...' : 'Upload & Analyze'}
                        </button>
                    </div>
                    {error && <div className="error">Error: {error}</div>}
                    {loading && <div className="loading">Processing PDF... This may take a moment.</div>}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
